<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>WoT Battle Tracker</title>
  <script src="https://unpkg.com/wotstat-widgets-sdk"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: rgba(0,0,0,0.8);
    }
    .tracker {
      background: rgba(0,0,0,0.7);
      border: 2px solid #ffc107;
      border-radius: 1em;
      padding: 1rem;
      width: 350px;
      box-shadow: 0 0 10px rgba(255,193,7,0.5);
      text-align: center;
    }
    .tracker h2 {
      margin: 0 0 0.5rem;
      color: #ffc107;
    }
    .tracker p {
      margin: 0.3rem 0;
    }
    .details {
      margin-top: 1rem;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0,0,0,0.5);
      padding: 0.5rem;
      border-radius: 0.5em;
      border: 1px solid #444;
      font-size: 0.8rem;
    }
    .details pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .details h4 {
      margin: 0 0 0.5rem;
      color: #4fc3f7;
      text-align: center;
    }
    .details-item {
      margin: 0.2rem 0;
    }
    .details-label {
      color: #ffb74d;
      font-weight: bold;
    }
    .details-value {
      color: #a5d6a7;
    }
    .toggle-details {
      margin-top: 0.5rem;
      background: #ffc107;
      border: none;
      padding: 0.3rem 0.8rem;
      border-radius: 0.3rem;
      cursor: pointer;
      font-weight: bold;
      color: #000;
    }
    .toggle-details:hover {
      background: #ffca28;
    }
  </style>
</head>
<body>
  <div class="tracker">
    <h2>WoT Battle Tracker</h2>
    <p>–ö—Ä–µ–¥–∏—Ç–∏: <span id="credits">0</span></p>
    <p>–ë–æ—ó: <span id="battles">0</span></p>
    <p>–ü–µ—Ä–µ–º–æ–≥–∏: <span id="wins">0</span></p>
    
    <button class="toggle-details" onclick="toggleDetails()">–ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –±–æ—é</button>
    
    <div class="details" id="battleDetails" style="display: none;">
      <h4>–î–∞–Ω—ñ –±–æ—é</h4>
      <div id="fullData"></div>
    </div>
  </div>

  <script type="module">
    import { WidgetSDK } from 'https://unpkg.com/wotstat-widgets-sdk?module';
    const sdk = new WidgetSDK();

    let totalCredits = 0;
    let battleCount = 0;
    let winCount = 0;

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt5kK9Vs7hVNevK4JY4YiubPdErlFpTi8JQ50i7AkeaKMKelBcJMQz40uol7rxiCtbpA/exec";

    function updateUI() {
      document.getElementById('credits').textContent = totalCredits.toLocaleString();
      document.getElementById('battles').textContent = battleCount;
      document.getElementById('wins').textContent = winCount;
    }

    function sendToSheet(payload) {
      const query = new URLSearchParams(payload).toString();
      const url = `${SCRIPT_URL}?${query}`;

      fetch(url)
        .then(res => res.text())
        .then(txt => console.log('Sheet response:', txt))
        .catch(err => console.error('Sheet error:', err));
    }

    function formatDataForDisplay(data) {
      let html = '';
      
      // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ result.common
      if (data.common) {
        html += `<div class="details-item"><span class="details-label">–ë–∏—Ç–≤–∞ ID:</span> <span class="details-value">${data.common.battleID || 'N/A'}</span></div>`;
        html += `<div class="details-item"><span class="details-label">–†–µ–∂–∏–º:</span> <span class="details-value">${data.common.gameMode || 'N/A'}</span></div>`;
        html += `<div class="details-item"><span class="details-label">–ö–∞—Ä—Ç–∞:</span> <span class="details-value">${data.common.mapName || 'N/A'}</span></div>`;
        html += `<div class="details-item"><span class="details-label">–î–∞—Ç–∏:</span> <span class="details-value">${data.common.dateTime || 'N/A'}</span></div>`;
        html += `<div class="details-item"><span class="details-label">–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å:</span> <span class="details-value">${data.common.winnerTeam || 'N/A'}</span></div>`;
        html += `<div class="details-item"><span class="details-label">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</span> <span class="details-value">${data.common.duration || 'N/A'} —Å–µ–∫</span></div>`;
      }

      // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (data.personal) {
        const pid = Object.keys(data.personal)[0];
        const personal = data.personal[pid];
        
        html += `<hr style="margin: 0.5rem 0; border-color: #555;">`;
        html += `<div style="color: #4fc3f7; margin: 0.5rem 0;"><strong>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ:</strong></div>`;
        
        for (const [key, value] of Object.entries(personal)) {
          if (typeof value === 'object') continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—ä–µ–∫—Ç—ã
          html += `<div class="details-item"><span class="details-label">${key}:</span> <span class="details-value">${value !== null && value !== undefined ? value : 'N/A'}</span></div>`;
        }
      }

      // –î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–æ–≤
      if (data.players) {
        html += `<hr style="margin: 0.5rem 0; border-color: #555;">`;
        html += `<div style="color: #4fc3f7; margin: 0.5rem 0;"><strong>–ì—Ä–∞–≤—Ü—ñ:</strong></div>`;
        html += `<div class="details-value" style="max-height: 100px; overflow-y: auto;">`;
        html += JSON.stringify(data.players, null, 2);
        html += `</div>`;
      }

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ SDK
      html += `<hr style="margin: 0.5rem 0; border-color: #555;">`;
      html += `<div style="color: #4fc3f7; margin: 0.5rem 0;"><strong>–î–∞–Ω—ñ SDK:</strong></div>`;
      html += `<div class="details-item"><span class="details-label">–ì—Ä–∞–≤–µ—Ü—å ID:</span> <span class="details-value">${sdk.data.player.id.value || 'N/A'}</span></div>`;
      html += `<div class="details-item"><span class="details-label">–¢–∞–Ω–∫:</span> <span class="details-value">${sdk.data.tank.name.value || 'N/A'}</span></div>`;
      html += `<div class="details-item"><span class="details-label">–ö–∞—Ä—Ç–∞:</span> <span class="details-value">${sdk.data.map.name.value || 'N/A'}</span></div>`;

      return html;
    }

    function displayFullData(result) {
      document.getElementById('fullData').innerHTML = formatDataForDisplay(result);
      document.getElementById('battleDetails').style.display = 'block';
    }

    window.toggleDetails = function() {
      const details = document.getElementById('battleDetails');
      const button = document.querySelector('.toggle-details');
      
      if (details.style.display === 'none') {
        details.style.display = 'block';
        button.textContent = '–°—Ö–æ–≤–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –±–æ—é';
      } else {
        details.style.display = 'none';
        button.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –±–æ—é';
      }
    }

    let lastPayloadHash = null;
    let lastSendTime = 0;

    sdk.data.battle.isInBattle.watch(inBattle => {
      if (inBattle) {
        battleCount++;
        updateUI();
      }
    });

    sdk.data.battle.onBattleResult.watch(result => {
      if (!result || !result.personal) return;

      const pid = Object.keys(result.personal)[0];
      const personal = result.personal[pid];
      const earned = personal.credits || 0;
      const repair = personal.autoRepairCost || 0;
      const equip  = personal.autoEquipCost?.[0] || 0;
      const load   = personal.autoLoadCost?.[0] || 0;
      const netCredits = earned - (repair + equip + load);
      totalCredits += netCredits;

      const myTeam = sdk.data.player.id.value;
      const teamId = result.players[myTeam]?.team;
      const winner = result.common?.winnerTeam;
      const isWin = teamId && winner && parseInt(teamId) === parseInt(winner);
      if (isWin) winCount++;

      updateUI();

      const now = new Date();
      const payload = {
        time:    now.toLocaleString('uk-UA'),
        battle:  battleCount,
        tank:    sdk.data.tank.name.value || '',
        map:     sdk.data.map.name.value || '',
        win:     isWin ? '–ü–µ—Ä–µ–º–æ–≥–∞' : '–ü–æ—Ä–∞–∑–∫–∞',
        damage:  personal.damageDealt || 0,
        assist:  (personal.damageAssisted || 0) + (personal.spottedAssisted || 0),
        credits: netCredits
      };

      const payloadHash = JSON.stringify(payload);
      const nowTime = Date.now();

      // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—É–±–ª—é–≤–∞–Ω–Ω—è
      if (payloadHash === lastPayloadHash && nowTime - lastSendTime < 3000) {
        console.log("üîÅ –¶–µ–π —Å–∞–º–∏–π –∑–∞–ø–∏—Å —É–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ.");
        return;
      }

      lastPayloadHash = payloadHash;
      lastSendTime = nowTime;

      console.log('üì§ –ù–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è:', payload);
      console.log('üìä –ü–æ–≤–Ω—ñ –¥–∞–Ω—ñ –±–æ—é:', result);
      
      // –í—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      displayFullData(result);
      
      sendToSheet(payload);
    });

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ SDK –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    console.log('SDK data structure:', sdk.data);
  </script>
</body>
</html>
