<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WoT Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@wargaming/sdk@1.0.6/dist/wg-sdk.min.js"></script>
</head>
<body>
  <h1>WoT Tracker is running...</h1>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt5kK9Vs7hVNevK4JY4YiubPdErlFpTi8JQ50i7AkeaKMKelBcJMQz40uol7rxiCtbpA/exec";

    let battleCount = 1;
    let lastPayloadHash = null;
    let lastSendTime = 0;

    function sendToSheet(payload) {
      const query = new URLSearchParams(payload).toString();
      const url = `${SCRIPT_URL}?${query}`;

      fetch(url)
        .then(res => res.text())
        .then(txt => console.log('Sheet response:', txt))
        .catch(err => console.error('Sheet error:', err));
    }

    sdk.ready.then(() => {
      sdk.data.battle.onBattleResult.watch(result => {
        if (!result || !result.personal) return;

        const pid = Object.keys(result.personal)[0];
        const personal = result.personal[pid];

        const earned = personal.credits || 0;
        const repair = personal.autoRepairCost || 0;
        const equip = personal.autoEquipCost?.[0] || 0;
        const load = personal.autoLoadCost?.[0] || 0;
        const netCredits = earned - (repair + equip + load);

        const myTeam = sdk.data.player.id.value;
        const teamId = result.players[myTeam]?.team;
        const winner = result.common?.winnerTeam;
        const isWin = teamId && winner && parseInt(teamId) === parseInt(winner);

        const tankName = sdk.data.tank.name.value || '';
        const mapName = sdk.data.map.name.value || '';
        const damage = personal.damageDealt || 0;
        const assist = (personal.damageAssisted || 0) + (personal.spottedAssisted || 0);

        const now = new Date();
        const payload = {
          time: now.toLocaleString('uk-UA'),
          battle: battleCount++,
          tank: tankName,
          map: mapName,
          win: isWin ? '–ü–µ—Ä–µ–º–æ–≥–∞' : '–ü–æ—Ä–∞–∑–∫–∞',
          damage: damage,
          assist: assist,
          credits: netCredits
        };

        const payloadHash = JSON.stringify(payload);
        const nowTime = Date.now();

        // ‚úÖ –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—É–±–ª—é–≤–∞–Ω–Ω—è
        if (payloadHash === lastPayloadHash && nowTime - lastSendTime < 3000) {
          console.log("üîÅ –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Å –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ");
          return;
        }

        lastPayloadHash = payloadHash;
        lastSendTime = nowTime;

        console.log('üì§ –í—ñ–¥–ø—Ä–∞–≤–∫–∞:', payload);
        sendToSheet(payload);
      });
    });
  </script>
</body>
</html>
