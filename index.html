<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WoT Tracker</title>
  <script src="https://sdk.wgapps.ru/wot/sdk.js"></script>
</head>
<body>
  <h1>WoT Tracker is running...</h1>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzFFBYqXKOJ5ePuUqNh-nlkVjcUAPW5ax_scyIcd0TlXC6q6TJKY8MWHsSd_gg0p-Nj0Q/exec";

    let lastBattleId = localStorage.getItem("lastBattleId");

    sdk.ready.then(() => {
      console.log("SDK ready");

      sdk.data.battle.onBattleResult.watch(result => {
        const battleId = result.battle_id;
        if (battleId === lastBattleId) {
          console.log("Duplicate battle, skipping...");
          return;
        }

        lastBattleId = battleId;
        localStorage.setItem("lastBattleId", battleId);

        const timestamp = new Date().toLocaleString('uk-UA');
        const accountId = result.account_id;
        const battleCount = 1;
        const victory = result.is_victory ? "Перемога" : "Поразка";
        const damage = result.damage_dealt;
        const frags = result.frags;
        const credits = result.credits;

        const payload = {
          time: timestamp,
          count: battleCount,
          id: accountId,
          result: victory,
          damage: damage,
          frags: frags,
          credits: credits
        };

        console.log("Sending data to Google Sheet:", payload);

        fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });
      });
    });
  </script>
</body>
</html>
