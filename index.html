<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>WoT Battle Tracker</title>
  <script src="https://unpkg.com/wotstat-widgets-sdk"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: transparent;
    }
    .tracker {
      background: rgba(0,0,0,0.5);
      border: 2px solid #ffc107;
      border-radius: 1em;
      padding: 1rem;
      width: 320px;
      box-shadow: 0 0 10px rgba(255,193,7,0.5);
      text-align: center;
    }
    .tracker h2 {
      margin: 0 0 0.5rem;
      color: #ffc107;
    }
    .tracker p {
      margin: 0.3rem 0;
    }
  </style>
</head>
<body>

<div class="tracker">
  <h2>WoT Battle Tracker</h2>
  <p>–°—Ä—ñ–±–ª–æ (—Å–µ—Å—ñ—è): <span id="credits">0</span></p>
  <p>–ë–æ—ó: <span id="battles">0</span></p>
  <p>–ü–µ—Ä–µ–º–æ–≥–∏: <span id="wins">0</span></p>
</div>

<script type="module">
import { WidgetSDK } from 'https://unpkg.com/wotstat-widgets-sdk?module';
const sdk = new WidgetSDK();

let totalCredits = 0;
let battleCount = 0;
let winCount = 0;

// –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å—Ä—ñ–±–ª–∞
let creditsBeforeBattle = null;

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt5kK9Vs7hVNevK4JY4YiubPdErlFpTi8JQ50i7AkeaKMKelBcJMQz40uol7rxiCtbpA/exec";

function updateUI() {
  document.getElementById('credits').textContent = totalCredits.toLocaleString();
  document.getElementById('battles').textContent = battleCount;
  document.getElementById('wins').textContent = winCount;
}

function sendToSheet(payload) {
  const query = new URLSearchParams(payload).toString();
  fetch(`${SCRIPT_URL}?${query}`)
    .then(r => r.text())
    .then(t => console.log('Sheet:', t))
    .catch(e => console.error('Sheet error:', e));
}

// —Ñ—ñ–∫—Å—É—î–º–æ —Å—Ä—ñ–±–ª–æ –ü–ï–†–ï–î –±–æ—î–º
sdk.data.battle.isInBattle.watch(inBattle => {
  if (inBattle) {
    battleCount++;
    creditsBeforeBattle = sdk.data.player.credits.value;
    updateUI();
  }
});

sdk.data.battle.onBattleResult.watch(result => {
  if (!result || !result.personal) return;

  const pid = Object.keys(result.personal)[0];
  const p = result.personal[pid];

  // –†–ï–ê–õ–¨–ù–ï —Å—Ä—ñ–±–ª–æ —á–µ—Ä–µ–∑ –¥–µ–ª—å—Ç—É
  const creditsAfter = sdk.data.player.credits.value;
  const deltaCredits = (creditsBeforeBattle !== null)
    ? creditsAfter - creditsBeforeBattle
    : 0;

  totalCredits += deltaCredits;

  const myId = sdk.data.player.id.value;
  const myTeam = result.players?.[myId]?.team;
  const winner = result.common?.winnerTeam;
  const isWin = myTeam && winner && Number(myTeam) === Number(winner);
  if (isWin) winCount++;

  updateUI();

  const now = new Date();

  const payload = {
    // TIME
    time_iso: now.toISOString(),
    time_local: now.toLocaleString('uk-UA'),

    // META
    game_mode: result.common?.gameMode || '',
    arena_id: result.common?.arenaUniqueID || '',
    is_finished: result.common?.isFinished ?? '',
    duration: result.common?.duration ?? '',
    phase: result.common?.phase ?? '',

    // MAP / TANK
    map: sdk.data.map.name.value || '',
    tank: sdk.data.tank.name.value || '',
    tank_level: sdk.data.tank.level.value || '',
    tank_class: sdk.data.tank.type.value || '',

    // RESULT
    my_team: myTeam || '',
    winner_team: winner || '',
    win: isWin ? 1 : 0,

    // SILVER (–í–°–ï –©–û –ú–û–ñ–õ–ò–í–û)
    credits_before: creditsBeforeBattle,
    credits_after: creditsAfter,
    credits_delta_real: deltaCredits,          // –ì–û–õ–û–í–ù–ï
    credits_raw: p.credits || 0,
    repair_cost: p.autoRepairCost || 0,
    equip_cost: (p.autoEquipCost || []).reduce((a,b)=>a+b,0),
    ammo_cost: (p.autoLoadCost || []).reduce((a,b)=>a+b,0),

    // XP
    xp: p.xp || 0,
    xp_raw: p.xpBeforeBonuses || 0,
    free_xp: p.freeXP || 0,
    booster_xp: p.boosterXP || 0,

    // ECONOMY EXTRA
    bonds: p.bonds || 0,
    gold: p.gold || 0,
    premium: p.isPremium || false,
    booster_credits: p.boosterCredits || 0,

    // COMBAT
    damage_dealt: p.damageDealt || 0,
    damage_received: p.damageReceived || 0,
    damage_blocked: p.damageBlockedByArmor || 0,

    assist_track: p.damageAssisted || 0,
    assist_spot: p.spottedAssisted || 0,
    assist_stun: p.stunAssisted || 0,

    frags: p.frags || 0,
    shots: p.shots || 0,
    hits: p.hits || 0,
    penetrations: p.piercings || 0,

    cap: p.capturePoints || 0,
    def: p.defencePoints || 0,
    mileage: p.mileage || 0,

    // FRONTLINE (—è–∫—â–æ —î)
    frontline_rank: p.rank || '',
    frontline_points: p.frontlinePoints || ''
  };

  console.log('üì§ PAYLOAD:', payload);
  sendToSheet(payload);
});
</script>

</body>
</html>
